name: ESP32 Hardware Testing

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# ðŸ”’ One hardware user at a time
concurrency:
  group: esp32-hardware
  cancel-in-progress: false

env:
  ESP_PORT: COM5
  FIRMWARE: firmware/ESP32_GENERIC-SPIRAM-20251209-v1.27.0.bin
  PYTHONUNBUFFERED: "1"

jobs:

# =========================================================
# PREFLIGHT
# =========================================================
  preflight:
    name: Preflight
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Verify Python
        shell: cmd
        run: |
          where python
          python --version

      - name: Detect COM ports
        shell: cmd
        run: |
          python -c "import serial.tools.list_ports; print([p.device for p in serial.tools.list_ports.comports()])"

      - name: Install tools
        shell: cmd
        run: |
          python -m pip install --upgrade pip
          python -m pip install esptool mpremote

# =========================================================
# FLASH FIRMWARE
# =========================================================
  flash-firmware:
    name: Flash ESP32 Firmware
    runs-on: self-hosted
    needs: preflight

    steps:
      - uses: actions/checkout@v4

      - name: Flash ESP32
        shell: cmd
        continue-on-error: true
        run: |
          python -m esptool --chip esp32 --port %ESP_PORT% erase-flash
          python -m esptool --chip esp32 --port %ESP_PORT% write-flash -z 0x1000 %FIRMWARE%

      - name: Wait for reboot
        shell: powershell
        run: Start-Sleep -Seconds 15

# =========================================================
# UPLOAD TEST FILES
# =========================================================
  upload-test-files:
    name: Upload Test Files
    runs-on: self-hosted
    needs: flash-firmware

    steps:
      - uses: actions/checkout@v4

      - name: Upload ALL test files
        shell: cmd
        run: |
          for %%f in (test_temp\*.py) do python -m mpremote connect %ESP_PORT% fs cp "%%f" :
          for %%f in (tests_wifi\*.py) do python -m mpremote connect %ESP_PORT% fs cp "%%f" :
          for %%f in (tests_bt\*.py) do python -m mpremote connect %ESP_PORT% fs cp "%%f" :
          for %%f in (tests_selftest_DS18B20_gps_wifi\*.py) do python -m mpremote connect %ESP_PORT% fs cp "%%f" :

# =========================================================
# SYSTEM SELF TEST (HARD GATE)
# =========================================================
  system-self-test:
    name: System Self-Test (HARD GATE)
    runs-on: self-hosted
    needs: upload-test-files

    steps:
      - name: Run system self-test
        shell: cmd
        run: |
          python -m mpremote connect %ESP_PORT% exec "import test_runner_system; test_runner_system.main()" > system.txt
          type system.txt
          findstr /C:"CI_RESULT: PASS" system.txt >nul
          if %errorlevel% neq 0 exit /b 1

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: system-self-test-log
          path: system.txt

# =========================================================
# DS18B20
# =========================================================
  ds18b20-tests:
    name: DS18B20 Temperature Tests
    runs-on: self-hosted
    needs: system-self-test

    steps:
      - name: Run DS18B20 tests
        shell: cmd
        run: |
          python -m mpremote connect %ESP_PORT% exec "import test_runner_ds18b20; test_runner_ds18b20.main()" > temp.txt
          type temp.txt
          findstr /C:"CI_RESULT: FAIL" temp.txt >nul && exit /b 1

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ds18b20-log
          path: temp.txt

# =========================================================
# WIFI
# =========================================================
  wifi-tests:
    name: Wi-Fi Tests
    runs-on: self-hosted

    steps:
      - name: Run Wi-Fi tests
        shell: cmd
        run: |
          python -m mpremote connect %ESP_PORT% exec "import test_wifi_runner; test_wifi_runner.run_all_wifi_tests()" > wifi.txt
          type wifi.txt
          findstr /C:"CI_RESULT: FAIL" wifi.txt >nul && exit /b 1

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: wifi-log
          path: wifi.txt

# =========================================================
# BLUETOOTH
# =========================================================
  bluetooth-tests:
    name: Bluetooth Tests
    runs-on: self-hosted

    steps:
      - name: Run Bluetooth tests
        shell: cmd
        run: |
          python -m mpremote connect %ESP_PORT% exec "import test_runner_bt; test_runner_bt.run_all_tests()" > bt.txt
          type bt.txt
          findstr /C:"CI_RESULT: FAIL" bt.txt >nul && exit /b 1

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bluetooth-log
          path: bt.txt

# =========================================================
# FINAL VERDICT
# =========================================================
  final-verdict:
    name: Final CI Verdict
    runs-on: self-hosted
    needs:
      - preflight
      - flash-firmware
      - upload-test-files
      - system-self-test
      - ds18b20-tests
      - wifi-tests
      - bluetooth-tests
    if: always()

    steps:
      - name: Evaluate results
        shell: cmd
        run: |
          if "${{ needs.preflight.result }}"=="failure" exit /b 1
          if "${{ needs.flash-firmware.result }}"=="failure" exit /b 1
          if "${{ needs.upload-test-files.result }}"=="failure" exit /b 1
          if "${{ needs.system-self-test.result }}"=="failure" exit /b 1
          if "${{ needs.ds18b20-tests.result }}"=="failure" exit /b 1
          if "${{ needs.wifi-tests.result }}"=="failure" exit /b 1
          if "${{ needs.bluetooth-tests.result }}"=="failure" exit /b 1
          echo ALL TEST SUITES PASSED
