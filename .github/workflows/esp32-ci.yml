name: ESP32 Hardware Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  ESP_PORT: COM5
  FIRMWARE: firmware/ESP32_GENERIC-SPIRAM-20251209-v1.27.0.bin
  PYTHONUNBUFFERED: "1"

jobs:
  esp32-tests:
    name: ESP32 Hardware Validation
    runs-on: self-hosted

    steps:
    # =========================================================
    # CHECKOUT
    # =========================================================
    - name: Checkout repository
      uses: actions/checkout@v4

    # =========================================================
    # VERIFY PYTHON
    # =========================================================
    - name: Verify Python Environment
      shell: cmd
      run: |
        where python
        python --version
        python -m pip --version

    # =========================================================
    # INSTALL HOST TOOLS
    # =========================================================
    - name: Install ESP32 host tools
      shell: cmd
      run: |
        python -m pip install --upgrade pip
        python -m pip install esptool mpremote

    # =========================================================
    # FLASH ESP32 (OPTIONAL â€“ SAME AS JENKINS)
    # =========================================================
    - name: Flash ESP32 (optional)
      shell: cmd
      continue-on-error: true
      run: |
        python -m esptool --chip esp32 --port %ESP_PORT% erase-flash
        python -m esptool --chip esp32 --port %ESP_PORT% write-flash -z 0x1000 %FIRMWARE%

    # =========================================================
    # WAIT FOR BOOT (CI-SAFE)
    # =========================================================
    - name: Wait for ESP32 reboot
      shell: powershell
      run: |
        Start-Sleep -Seconds 10

    # =========================================================
    # LOGICAL RESET (CI-SAFE)
    # =========================================================
    - name: Reset ESP32 (MicroPython)
      shell: cmd
      run: |
        python -m mpremote connect COM5 reset || exit /b 1
        timeout /t 3 >nul

    - name: Wait after reset
      shell: powershell
      run: |
        Start-Sleep -Seconds 3

    # =========================================================
    # UPLOAD TEST FILES
    # =========================================================
    - name: Upload test files
      shell: cmd
      run: |
        for %%f in (test_temp\*.py) do python -m mpremote connect %ESP_PORT% fs cp "%%f" :
        for %%f in (tests_wifi\*.py) do python -m mpremote connect %ESP_PORT% fs cp "%%f" :
        for %%f in (tests_bt\*.py)   do python -m mpremote connect %ESP_PORT% fs cp "%%f" :
        for %%f in (tests_selftest_DS18B20_gps_wifi\*.py) do python -m mpremote connect %ESP_PORT% fs cp "%%f" :

    # =========================================================
    # SYSTEM SELF TEST (HARD GATE)
    # =========================================================
    - name: System Self-Test (HARD GATE)
      shell: cmd
      run: |
        python -m mpremote connect %ESP_PORT% exec "import test_runner_system; test_runner_system.main()" > system.txt
        type system.txt

        findstr /C:"CI_RESULT: FAIL" system.txt >nul
        if %errorlevel%==0 (
          echo SYSTEM SELF-TEST FAILED
          exit /b 1
        )

        echo SYSTEM SELF-TEST PASSED

    # =========================================================
    # DS18B20 TEMPERATURE TESTS
    # =========================================================
    - name: DS18B20 Temperature Tests
      shell: cmd
      run: |
        python -m mpremote connect %ESP_PORT% exec "import test_runner_ds18b20; test_runner_ds18b20.main()" > temp.txt
        type temp.txt

        findstr /C:"CI_RESULT: FAIL" temp.txt >nul
        if %errorlevel%==0 exit /b 1

    # =========================================================
    # WI-FI TESTS
    # =========================================================
    - name: Wi-Fi Tests
      shell: cmd
      run: |
        python -m mpremote connect %ESP_PORT% exec "import test_wifi_runner; test_wifi_runner.run_all_wifi_tests()" > wifi.txt
        type wifi.txt

        findstr /C:"CI_RESULT: FAIL" wifi.txt >nul
        if %errorlevel%==0 exit /b 1

    # =========================================================
    # BLUETOOTH TESTS
    # =========================================================
    - name: Bluetooth Tests
      shell: cmd
      run: |
        python -m mpremote connect %ESP_PORT% exec "import test_runner_bt; test_runner_bt.run_all_tests()" > bt.txt
        type bt.txt

        findstr /C:"CI_RESULT: FAIL" bt.txt >nul
        if %errorlevel%==0 exit /b 1

    # =========================================================
    # FINAL VERDICT
    # =========================================================
    - name: Final CI Verdict
      shell: cmd
      run: |
        echo Temperature : PASS
        echo Wi-Fi       : PASS
        echo Bluetooth   : PASS
        echo ALL TEST SUITES PASSED

    # =========================================================
    # ARTIFACTS
    # =========================================================
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: esp32-test-logs
        path: |
          *.txt

