name: ESP32 Hardware Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  ESP_PORT: COM5
  FIRMWARE_PATH: firmware/ESP32_GENERIC-SPIRAM-20251209-v1.27.0.bin

jobs:
  esp32-hardware-tests:
    name: ESP32 Hardware Validation
    runs-on: self-hosted   # REQUIRED for COM port access

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install ESP32 Tools
      shell: cmd
      run: |
        pip install --upgrade pip
        pip install esptool mpremote pyserial

    - name: Upload Test Files
      shell: cmd
      run: |
        for %%f in (test_temp\*.py) do python -m mpremote connect %ESP_PORT% fs cp "%%f" :
        for %%f in (tests_wifi\*.py) do python -m mpremote connect %ESP_PORT% fs cp "%%f" :
        for %%f in (tests_bt\*.py) do python -m mpremote connect %ESP_PORT% fs cp "%%f" :
        for %%f in (tests_selftest_DS18B20_gps_wifi\*.py) do python -m mpremote connect %ESP_PORT% fs cp "%%f" :

    # ================= SYSTEM SELF TEST (HARD GATE) =================

    - name: System Self-Test (HARD GATE)
      id: system_test
      shell: cmd
      run: |
        python -m mpremote connect %ESP_PORT% exec ^
        "import test_runner_system; test_runner_system.main()" ^
        > system.txt

        type system.txt

        findstr /C:"CI_RESULT: FAIL" system.txt >nul
        if %errorlevel%==0 (
          echo system_test_result=fail>>"%GITHUB_OUTPUT%"
          exit /b 1
        )

        echo system_test_result=pass>>"%GITHUB_OUTPUT%"

    # ================= DS18B20 =================

    - name: DS18B20 Temperature Tests
      id: temp_test
      if: steps.system_test.outputs.system_test_result == 'pass'
      shell: cmd
      run: |
        python -m mpremote connect %ESP_PORT% exec ^
        "import test_runner_ds18b20; test_runner_ds18b20.main()" ^
        > temp.txt

        type temp.txt

        findstr /C:"CI_RESULT: FAIL" temp.txt >nul
        if %errorlevel%==0 (
          echo temp_test_result=fail>>"%GITHUB_OUTPUT%"
          exit /b 1
        )

        echo temp_test_result=pass>>"%GITHUB_OUTPUT%"

    # ================= WIFI =================

    - name: Wi-Fi Tests
      id: wifi_test
      if: steps.temp_test.outputs.temp_test_result == 'pass'
      shell: cmd
      run: |
        python -m mpremote connect %ESP_PORT% exec ^
        "import test_wifi_runner; test_wifi_runner.run_all_wifi_tests()" ^
        > wifi.txt

        type wifi.txt

        findstr /C:"CI_RESULT: FAIL" wifi.txt >nul
        if %errorlevel%==0 (
          echo wifi_test_result=fail>>"%GITHUB_OUTPUT%"
          exit /b 1
        )

        echo wifi_test_result=pass>>"%GITHUB_OUTPUT%"

    # ================= BLUETOOTH =================

    - name: Bluetooth Tests
      id: bt_test
      if: steps.wifi_test.outputs.wifi_test_result == 'pass'
      shell: cmd
      run: |
        python -m mpremote connect %ESP_PORT% exec ^
        "import test_runner_bt; test_runner_bt.run_all_tests()" ^
        > bt.txt

        type bt.txt

        findstr /C:"CI_RESULT: FAIL" bt.txt >nul
        if %errorlevel%==0 (
          echo bt_test_result=fail>>"%GITHUB_OUTPUT%"
          exit /b 1
        )

        echo bt_test_result=pass>>"%GITHUB_OUTPUT%"

    # ================= ARTIFACTS =================

    - name: Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: esp32-test-logs
        path: "*.txt"

