name: ESP32 Hardware CI

on:
  push:
    branches: [ main ]
  pull_request:

# ðŸš« HARDWARE LOCK â€” only one job may touch COM5
concurrency:
  group: esp32-hardware
  cancel-in-progress: false

jobs:
  esp32-tests:
    runs-on: windows-latest

    steps:
      # ---------------- CHECKOUT ----------------
      - name: Checkout
        uses: actions/checkout@v4

      # ---------------- PYTHON ----------------
      - name: Verify Python
        run: |
          where python
          python --version
          python -m pip --version
        shell: cmd

      - name: Install tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install esptool mpremote pyserial
        shell: cmd

      # ---------------- COM PORT GUARD ----------------
      - name: Verify COM5 is free
        run: |
          python - <<EOF
          import serial, sys
          try:
              s = serial.Serial("COM5", 115200, timeout=1)
              s.close()
              print("COM5 is free")
          except Exception as e:
              print("COM5 is BUSY:", e)
              sys.exit(1)
          EOF
        shell: cmd

      # ---------------- FORCE RESET ----------------
      - name: Reset ESP32 and release port
        run: |
          python -m mpremote disconnect || exit /b 0
          python -m mpremote connect COM5 reset
          timeout /t 3 >nul
        shell: cmd

      # ---------------- FLASH (OPTIONAL) ----------------
      - name: Flash firmware (optional)
        run: |
          python -m esptool --chip esp32 --port COM5 erase-flash || echo Skipping erase
          python -m esptool --chip esp32 --port COM5 write-flash -z 0x1000 firmware/ESP32_GENERIC-SPIRAM-20251209-v1.27.0.bin || echo Skipping flash
        shell: cmd

      - name: Wait for reboot
        run: python -c "import time; time.sleep(10)"
        shell: cmd

      # ---------------- UPLOAD TESTS ----------------
      - name: Upload test files
        run: |
          for %%f in (test_temp\*.py) do python -m mpremote connect COM5 fs cp %%f :
          for %%f in (tests_wifi\*.py) do python -m mpremote connect COM5 fs cp %%f :
          for %%f in (tests_bt\*.py)   do python -m mpremote connect COM5 fs cp %%f :
          for %%f in (tests_selftest_DS18B20_gps_wifi\*.py) do python -m mpremote connect COM5 fs cp %%f :
        shell: cmd

      # ---------------- SYSTEM SELF TEST (HARD GATE) ----------------
      - name: System Self-Test (HARD GATE)
        run: |
          python -m mpremote connect COM5 exec ^
          "import test_runner_system; test_runner_system.main()" ^
          > system.txt

          type system.txt
          findstr /C:"CI_RESULT: FAIL" system.txt >nul && exit /b 1
        shell: cmd

      # ---------------- DS18B20 ----------------
      - name: DS18B20 Tests
        continue-on-error: true
        run: |
          python -m mpremote connect COM5 exec ^
          "import test_runner_ds18b20; test_runner_ds18b20.main()" ^
          > temp.txt

          type temp.txt
          findstr /C:"CI_RESULT: FAIL" temp.txt >nul && exit /b 1
        shell: cmd

      # ---------------- WIFI ----------------
      - name: Wi-Fi Tests
        continue-on-error: true
        run: |
          python -m mpremote connect COM5 exec ^
          "import test_wifi_runner; test_wifi_runner.run_all_wifi_tests()" ^
          > wifi.txt

          type wifi.txt
          findstr /C:"CI_RESULT: FAIL" wifi.txt >nul && exit /b 1
        shell: cmd

      # ---------------- BLUETOOTH ----------------
      - name: Bluetooth Tests
        continue-on-error: true
        run: |
          python -m mpremote connect COM5 exec ^
          "import test_runner_bt; test_runner_bt.run_all_tests()" ^
          > bt.txt

          type bt.txt
          findstr /C:"CI_RESULT: FAIL" bt.txt >nul && exit /b 1
        shell: cmd

      # ---------------- FINAL VERDICT ----------------
      - name: Final CI Verdict
        run: |
          echo ==== FINAL RESULTS ====
          if exist temp.txt findstr /C:"CI_RESULT: FAIL" temp.txt >nul && exit /b 1
          if exist wifi.txt findstr /C:"CI_RESULT: FAIL" wifi.txt >nul && exit /b 1
          if exist bt.txt   findstr /C:"CI_RESULT: FAIL" bt.txt   >nul && exit /b 1
          echo ALL TEST SUITES PASSED
        shell: cmd

      # ---------------- ARTIFACTS ----------------
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: esp32-logs
          path: "*.txt"

