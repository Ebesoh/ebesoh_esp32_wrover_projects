name: ESP32 Hardware Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  ESP_PORT: COM5
  FIRMWARE_PATH: firmware/ESP32_GENERIC-SPIRAM-20251209-v1.27.0.bin

jobs:
  esp32-hardware-tests:
    name: ESP32 Hardware Validation
    runs-on: self-hosted

    steps:
    # =========================================================
    # CHECKOUT
    # =========================================================
    - name: Checkout repository
      uses: actions/checkout@v4

    # =========================================================
    # VERIFY PYTHON (PREINSTALLED)
    # =========================================================
    - name: Verify Python on runner
      shell: cmd
      run: |
        python --version
        pip --version
        where python

    # =========================================================
    # INSTALL TOOLS
    # =========================================================
    - name: Install ESP32 host tools
      shell: cmd
      run: |
        pip install --upgrade pip
        pip install esptool mpremote pyserial

    # =========================================================
    # DEBUG: COM PORTS
    # =========================================================
    - name: List COM ports
      shell: cmd
      run: |
        python -c "import serial.tools.list_ports; print([p.device for p in serial.tools.list_ports.comports()])"

    # =========================================================
    # RESET DEVICE (CI-SAFE FIX)
    # =========================================================
    - name: Reset ESP32 (CI-safe)
      shell: cmd
      run: |
        python -m mpremote connect %ESP_PORT% exec "import machine; machine.reset()"
        timeout /t 3 /nobreak > nul

    # =========================================================
    # UPLOAD TEST FILES
    # =========================================================
    - name: Upload test files to ESP32
      shell: cmd
      run: |
        for %%f in (test_temp\*.py) do python -m mpremote connect %ESP_PORT% fs cp "%%f" :
        for %%f in (tests_wifi\*.py) do python -m mpremote connect %ESP_PORT% fs cp "%%f" :
        for %%f in (tests_bt\*.py) do python -m mpremote connect %ESP_PORT% fs cp "%%f" :
        for %%f in (tests_selftest_DS18B20_gps_wifi\*.py) do python -m mpremote connect %ESP_PORT% fs cp "%%f" :

    # =========================================================
    # SYSTEM SELF TEST (HARD GATE)
    # =========================================================
    - name: System Self-Test (HARD GATE)
      id: system
      shell: cmd
      run: |
        python -m mpremote connect %ESP_PORT% exec "import test_runner_system; test_runner_system.main()" > system.txt
        type system.txt

        findstr /C:"CI_RESULT: FAIL" system.txt >nul
        if %errorlevel%==0 (
          echo SYSTEM TEST FAILED
          exit /b 1
        )

        echo SYSTEM TEST PASSED

    # =========================================================
    # DS18B20 TEMPERATURE TESTS
    # =========================================================
    - name: DS18B20 Temperature Tests
      id: temp
      shell: cmd
      continue-on-error: true
      run: |
        python -m mpremote connect %ESP_PORT% exec "import test_runner_ds18b20; test_runner_ds18b20.main()" > temp.txt
        type temp.txt

        findstr /C:"CI_RESULT: FAIL" temp.txt >nul
        if %errorlevel%==0 exit /b 1

    # =========================================================
    # WIFI TESTS
    # =========================================================
    - name: Wi-Fi Tests
      id: wifi
      shell: cmd
      continue-on-error: true
      run: |
        python -m mpremote connect %ESP_PORT% exec "import test_wifi_runner; test_wifi_runner.run_all_wifi_tests()" > wifi.txt
        type wifi.txt

        findstr /C:"CI_RESULT: FAIL" wifi.txt >nul
        if %errorlevel%==0 exit /b 1

    # =========================================================
    # BLUETOOTH TESTS
    # =========================================================
    - name: Bluetooth Tests
      id: bt
      shell: cmd
      continue-on-error: true
      run: |
        python -m mpremote connect %ESP_PORT% exec "import test_runner_bt; test_runner_bt.run_all_tests()" > bt.txt
        type bt.txt

        findstr /C:"CI_RESULT: FAIL" bt.txt >nul
        if %errorlevel%==0 exit /b 1

    # =========================================================
    # FINAL DECISION
    # =========================================================
    - name: Final CI Verdict
      shell: bash
      run: |
        echo "=== FINAL TEST SUMMARY ==="
        echo "System     : PASSED"
        echo "Temperature: ${{ steps.temp.outcome }}"
        echo "Wi-Fi      : ${{ steps.wifi.outcome }}"
        echo "Bluetooth  : ${{ steps.bt.outcome }}"

        if [[ "${{ steps.temp.outcome }}" == "failure" ||
              "${{ steps.wifi.outcome }}" == "failure" ||
              "${{ steps.bt.outcome }}" == "failure" ]]; then
          echo "❌ One or more test suites failed"
          exit 1
        fi

        echo "✅ ALL TEST SUITES PASSED"

    # =========================================================
    # ARTIFACTS
    # =========================================================
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: esp32-test-logs
        path: |
          *.txt

